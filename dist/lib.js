!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.crashme=t():e.crashme=t()}(this,(()=>(()=>{"use strict";var e={d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{initClientWorker:()=>f,initCrashDetection:()=>c,initDetectorWorker:()=>b});var n=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{u(r.next(e))}catch(e){a(e)}}function c(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,c)}u((r=r.apply(e,t||[])).next())}))},r=function(e,t){var n,r,o,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=c(0),i.throw=c(1),i.return=c(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(u){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,r=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){a.label=c[1];break}if(6===c[0]&&a.label<o[1]){a.label=o[1],o=c;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(c);break}o[2]&&a.ops.pop(),a.trys.pop();continue}c=t.call(e,a)}catch(e){c=[6,e],r=0}finally{n=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,u])}}};function o(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){return[2,new Promise((function(t,n){var r=indexedDB.open(e);r.onerror=function(e){n(r.error)},r.onsuccess=function(e){t(r.result)},r.onupgradeneeded=function(e){if(e.target){var t=r.result;t.objectStoreNames.contains("tabs")||t.createObjectStore("tabs",{keyPath:"id"})}}}))]}))}))}var a=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{u(r.next(e))}catch(e){a(e)}}function c(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,c)}u((r=r.apply(e,t||[])).next())}))},i=function(e,t){var n,r,o,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=c(0),i.throw=c(1),i.return=c(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(u){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,r=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){a.label=c[1];break}if(6===c[0]&&a.label<o[1]){a.label=o[1],o=c;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(c);break}o[2]&&a.ops.pop(),a.trys.pop();continue}c=t.call(e,a)}catch(e){c=[6,e],r=0}finally{n=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,u])}}};function c(e){var t,n,r,c={},u=function(t){var n;t.id=c.id,null===(n=e.log)||void 0===n||n.call(e,t)};function s(t){return a(this,void 0,void 0,(function(){var r,o;return i(this,(function(a){switch(a.label){case 0:return"crash-detected"!==t.data.event||t.data.reporter.id!==c.id?[3,2]:(u({event:"crash-detected"}),r=t.data.tab,[4,e.reportCrash(r)]);case 1:o=a.sent(),u({event:"crash-reported",success:o}),o&&(u({event:"crash-report-confirmed"}),n.port.postMessage({event:"crash-reported",id:t.data.tab.id})),a.label=2;case 2:return[2]}}))}))}function l(){e.updateInfo(c),u({event:"updated"}),t.postMessage({event:"update",info:c})}function f(){u({event:"loaded"}),window.addEventListener("click",d)}function d(){return a(this,void 0,void 0,(function(){return i(this,(function(o){return u({event:"started"}),window.removeEventListener("click",d),c.id=e.id,c.tabFirstActive=Date.now(),(t=e.createClientWorker()).addEventListener("message",l),(n=e.createDetectorWorker()).port.addEventListener("message",s),n.port.start(),window.addEventListener("beforeunload",(function(){u({event:"unloaded"}),r.transaction(["tabs"],"readwrite").objectStore("tabs").delete(c.id),t.postMessage({event:"close",info:c}),t.removeEventListener("message",l),n.port.removeEventListener("message",s),u({event:"unloaded-done"})})),t.postMessage({event:"start",info:c}),u({event:"started-done"}),[2]}))}))}o(e.dbName).then((function(e){return r=e})),"complete"===document.readyState?f():window.addEventListener("load",(function(){f()}))}var u=function(){return u=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},u.apply(this,arguments)},s=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{u(r.next(e))}catch(e){a(e)}}function c(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,c)}u((r=r.apply(e,t||[])).next())}))},l=function(e,t){var n,r,o,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=c(0),i.throw=c(1),i.return=c(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(u){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,r=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){a.label=c[1];break}if(6===c[0]&&a.label<o[1]){a.label=o[1],o=c;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(c);break}o[2]&&a.ops.pop(),a.trys.pop();continue}c=t.call(e,a)}catch(e){c=[6,e],r=0}finally{n=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,u])}}};function f(e){var t,n,r=this,a=Date.now();setInterval((function(){if(n){if(null==t?void 0:t.id){var e=n.transaction(["tabs"],"readwrite").objectStore("tabs"),r=Date.now();e.put(u(u({},structuredClone(t)),{tabLastActive:a,workerLastActive:r}))}postMessage({event:"ping"})}}),e.pingInterval),addEventListener("message",(function(i){return s(r,void 0,void 0,(function(){return l(this,(function(r){switch(r.label){case 0:return"update"===i.data.event&&(a=Date.now(),t=structuredClone(i.data.info)),"start"!==i.data.event?[3,2]:[4,o(e.dbName)];case 1:n=r.sent(),r.label=2;case 2:return"close"===i.data.event&&n.transaction(["tabs"],"readwrite").objectStore("tabs").delete(i.data.info.id),[2]}}))}))}))}var d=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{u(r.next(e))}catch(e){a(e)}}function c(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,c)}u((r=r.apply(e,t||[])).next())}))},p=function(e,t){var n,r,o,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=c(0),i.throw=c(1),i.return=c(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(u){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,r=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){a.label=c[1];break}if(6===c[0]&&a.label<o[1]){a.label=o[1],o=c;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(c);break}o[2]&&a.ops.pop(),a.trys.pop();continue}c=t.call(e,a)}catch(e){c=[6,e],r=0}finally{n=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,u])}}};function b(e){var t,n=!1,r=[];function a(e){"crash-reported"===e.data.event&&e.data.id&&t.transaction(["tabs"],"readwrite").objectStore("tabs").delete(e.data.id)}var i=e.inactivityThreshold;function c(){var e=t.transaction(["tabs"],"readwrite").objectStore("tabs").getAll();e.onsuccess=function(){var t=e.result,n=[],o=[];if(t.forEach((function(e){Date.now()-e.workerLastActive>i?o.push(e):n.push(e)})),0!==n.length){var a=n.pop();t.forEach((function(e){Date.now()-e.workerLastActive>i&&r.forEach((function(t){t.postMessage({event:"crash-detected",tab:e,reporter:a})}))}))}}}self.onconnect=function(u){return d(this,void 0,void 0,(function(){var s;return p(this,(function(l){switch(l.label){case 0:return n?[3,2]:[4,o(e.dbName)];case 1:t=l.sent(),s=u.ports[0],r.push(s),s.addEventListener("message",a),s.addEventListener("close",(function(){r=r.filter((function(e){return e!==s}))})),s.start(),setInterval(c,i),n=!0,l.label=2;case 2:return[2]}}))}))}}return t})()));
//# sourceMappingURL=lib.js.map